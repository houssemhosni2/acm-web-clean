<div class="card">
  <div class="p-3 d-flex justify-content-end">
    <button class="btn-icon btn btn-success" (click)="addStep('NEW_APPLICATION')">
      <fa-icon class="mx-2" [icon]="library.getIconDefinition('fas', 'plus')"></fa-icon>
      {{ "add_new_step" | translate }}
    </button>
    <button class="btn-icon btn btn-warning" style="margin-left: 18px;"
      (click)="duplicateStep(content,'NEW_APPLICATION')">
      <i class="pe-7s-photo-gallery btn-icon-wrapper"></i>
      {{ 'setting.setting_configuration_product.duplicate' | translate }}
    </button>
  </div>
  <div class="card-body">
    <div cdkDropList class="example-list-without-overflow" (cdkDropListDropped)="drop($event, 'NEW_APPLICATION')">
      <h6 class="text-danger p-4 m-0" *ngIf="newLoanApplicationSteps.length === 0">
        {{'setting.setting_level.no_level_process_for_this_product'|translate}}
      </h6>
      <div class="example-box" *ngFor="let newLoanApplicationStep of newLoanApplicationSteps; let i = index" cdkDrag>
        <div class="card col-12">
          <div class="card-header" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
            <div class="px-3">
              <p class="text-primary m-0">
                {{ "step" | translate }} {{ i + 1 }}
              </p>
            </div>
            <div class="col-9 row px-3">
              <input type="text" [ngClass]="{'form-control': true,'input-error': !newLoanApplicationStep.stepName}"
                [(ngModel)]="newLoanApplicationStep.stepName" />
            </div>
            <span class="text-danger"> * </span>
            <div class="mx-auto row">
              <div class>
                <mat-checkbox
                [(ngModel)]="newLoanApplicationStep.automaticStep"
                (change)="showInputsMethod($event.checked,newLoanApplicationStep)">
                  {{"automatic_step"|translate}}
                </mat-checkbox>
                <button class="btn-icon btn-icon-only btn-outline-2x btn btn-outline-danger ml-2"
                  (click)="deleteStep(i)" style="margin-left: 10px;">
                  <i class="lnr-trash btn-icon-wrapper"></i>
                </button>
              </div>
            </div>

            <div class="mx-auto" (click)="toggleCollapse(i, 'NEW_APPLICATION')">
              <i [ngClass]="
            newLoanApplicationExpands[i] === true
                  ? 'lnr-chevron-up text-secondary'
                  : 'lnr-chevron-down text-secondary'
              "></i>
            </div>
          </div>
          <div [ngClass]="
        newLoanApplicationExpands[i] === true ? 'collapse show' : 'collapse'
          " aria-labelledby="headingOne" data-parent="#accordionExample">
            <div class="card-body row">
              <div *ngIf="newLoanApplicationStep.automaticStep">
                <div class="row">
                  <div class="position-relative form-group col-4 col-md-4 py-2">
                    <label>{{"rejection_condition"|translate}}</label>
                    <select class="form-control" [(ngModel)]="newLoanApplicationStep.rejectionCondition">
                      <option [value]="null"></option>
                      <option *ngFor="let f of providerFields" [value]="f.name">
                        {{ f.name }}
                      </option>
                    </select>
                  </div>
                  <div class="position-relative form-group col-4 col-md-4 py-2">
                    <label>{{"min_score_rejected"|translate}}</label>
                    <input type="number" class="form-control" placeholder="Min Score Rejected"
                      [(ngModel)]="newLoanApplicationStep.minScoreRejected">
                  </div>
                  <div class="position-relative form-group col-4 col-md-4 py-2">
                    <label>{{"Max_score_rejected"|translate}}</label>
                    <input type="number" class="form-control" placeholder="Max Score Rejected"
                      [(ngModel)]="newLoanApplicationStep.maxScoreRejected">
                  </div>
                  <div class="position-relative form-group col-4 col-md-4 py-2">
                    <label>{{"acceptation_condition"|translate}}</label>
                    <select class="form-control" [(ngModel)]="newLoanApplicationStep.acceptationCondition">
                      <option [value]="null"></option>
                      <option *ngFor="let f of providerFields" [value]="f.name">
                        {{ f.name }}
                      </option>
                    </select>
                  </div>
                  <div class="position-relative form-group col-4 col-md-4 py-2">
                    <label>{{"min_score_accepted"|translate}}</label>
                    <input type="number" class="form-control" placeholder="Min Score Accepted"
                      [(ngModel)]="newLoanApplicationStep.minScoreAccepted">
                  </div>
                  <div class="position-relative form-group col-4 col-md-4 py-2">
                    <label>{{"max_score_accepted"|translate}}</label>
                    <input type="number" class="form-control" placeholder="Max Score Accepted"
                      [(ngModel)]="newLoanApplicationStep.maxScoreAccepted">
                  </div>
                </div>


                <div class="px-3">
                  <hr class="hr" />
                </div>
              </div>
              <div class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ "loan.min_loan_amount" | translate }}</label>
                <span class="text-danger"> * </span>
                <input type="number" class="form-control" [(ngModel)]="newLoanApplicationStep.minAmount" />
              </div>
              <div class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ "loan.max_loan_amount" | translate }}</label>
                <span class="text-danger"> * </span>
                <input type="number" class="form-control" [(ngModel)]="newLoanApplicationStep.maxAmount" />
              </div>
              <div class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ "step_assgin" | translate }}</label>
                <span class="text-danger"> * </span>
                <select [ngClass]="{
                'form-control': true,
                'input-error': !newLoanApplicationStep.stepType
              }" [(ngModel)]="newLoanApplicationStep.stepType" (change)="stepTypeChanged('NEW_APPLICATION',i)">
                  <option [ngValue]="'group'">{{ "Assign_to_Group" | translate }}</option>
                  <option [ngValue]="'link'">{{ "Assign_to_User" | translate }}</option>
                  <option [ngValue]="'customer'">{{ "Assign_to_Customer" | translate }}</option>
                </select>
              </div>
              <div class="position-relative form-group col-4 col-md-4 py-2"
                *ngIf="newLoanApplicationStep.stepType === 'group'">
                <label>{{ "group_users" | translate }}:</label>
                <span class="text-danger"> * </span>
                <select [ngClass]="{'form-control': true,'input-error': !newLoanApplicationStep.groupSetting
                }" [(ngModel)]="newLoanApplicationStep.groupSetting" [compareWith]="compareGroup">
                  <option *ngFor="let groupEntity of groupEntities" [ngValue]="groupEntity">
                    {{ groupEntity.libelle }}
                  </option>
                </select>
              </div>
              <div class="position-relative form-group col-4 col-md-4 py-2"
                *ngIf="newLoanApplicationStep.stepType === 'link'">
                <label>{{ "user-step-link" | translate }}:</label>
                <span class="text-danger"> * </span>
                <select required [ngClass]="{
                  'form-control': true,
                  'input-error': !newLoanApplicationStep.previousStep
                }" [(ngModel)]="newLoanApplicationStep.previousStep">
                  <option *ngFor="let userLink of userLinks" [value]="userLink.linkValue"
                    [disabled]="newLoanApplicationStep.order===0 && (userLink.linkValue==-1 || userLink.linkValue==-2)"
                    [ngClass]="{ 'disabled-option': newLoanApplicationStep.order === 0 && (userLink.linkValue === -1 || userLink.linkValue === -2) }">
                    {{ userLink.LinkName }}
                  </option>
                  <option *ngFor="let previousStep of previousSteps(newLoanApplicationSteps, i)"
                    [value]="previousStep.order">
                    {{ previousStep.stepName }}
                  </option>
                </select>
              </div>
              <div class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ "screen_steps" | translate }}</label>
                <span class="text-danger"> * </span>
                <select [ngClass]="{
                'form-control': true,
                'input-error': !newLoanApplicationStep.screen
              }" [(ngModel)]="newLoanApplicationStep.screen">
                  <option *ngFor="let root of ihmRoot" [value]="root.ihmRoute">
                    {{ root.description }}
                  </option>
                </select>
              </div>
              <div class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ "ib_screen_steps" | translate }}</label>
                <!-- <span class="text-danger"> * </span> -->
                <select [ngClass]="{
                'form-control': true,
                'input-error': !newLoanApplicationStep.ibScreen
              }" [(ngModel)]="newLoanApplicationStep.ibScreen" (change)="clearSelection(i)">
                  <option *ngIf="newLoanApplicationStep.ibScreen" value="">{{'deselect_option' |translate}}</option>
                  <option *ngFor="let root of ibIhmRoot" [value]="root">
                    {{ root }}
                  </option>
                </select>
              </div>

              <div class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ "ib_step_name" | translate }}</label>
                  <input type="text" class="form-control" [(ngModel)]="newLoanApplicationStep.ibStepName" />
              </div>

              <div class="position-relative form-group col-4 col-md-4 py-2"
                *ngIf="newLoanApplicationStep.screen === '/screening'">
                <label>
                  {{'sidebar.screening_component'|translate}}</label>
                <ngx-select-dropdown tabindex="0" [multiple]="true" [options]="screenigComponents"
                  [(ngModel)]="selectedScreenComponents[i]" [config]="configScreenComponent"
                  (change)="getListOfScreen($event, i)">
                </ngx-select-dropdown>
              </div>
              <div *ngIf="newLoanApplicationStep.screen === '/loan-approval'"
                class="position-relative form-group col-4 col-md-4 py-2">
                <label>
                  {{'approval_participants'|translate}}</label>
                <ngx-select-dropdown tabindex="0" [multiple]="true" [(ngModel)]="
                newLoanApplicationStep.approvers
                  " [options]="optionsGroupUsers" [config]="configCollectionParticipants">
                </ngx-select-dropdown>
              </div>
              <div class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{
                  "collections.collection-dashboard.documents"
                  | translate
                  }}:</label>

                <p-multiSelect [options]="settingLoanDocumentsByProduct" [(ngModel)]="newLoanApplicationStep.documents"
                  optionLabel="settingDocumentTypeDTO.libelle"></p-multiSelect>
              </div>
              <div class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ "step_tab" | translate }}</label>
                <span class="text-danger"> * </span>
                <select [ngClass]="{'form-control': true,'input-error': !newLoanApplicationStep.codeStatutLoan}"
                  [(ngModel)]="newLoanApplicationStep.codeStatutLoan"
                  (change)="checkBoxCheckers(newLoanApplicationStep)">
                  <option *ngFor="let tap of stepTap" [value]="tap.tapValue">
                    {{ tap.tapName }}
                  </option>
                </select>
              </div>
              <!-- <div class="position-relative form-group col-4 col-md-4 py-2 ">
                <label>
                  {{"collections.collection-dashboard.participants"| translate}}:</label>
                <ngx-select-dropdown tabindex="0" [multiple]="true" [(ngModel)]="newLoanApplicationStep.participants"
                  [options]="optionsGroupUsers" [config]="configCollectionParticipants">
                </ngx-select-dropdown>
              </div> -->

              <div *ngIf="serviceSMS" class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ "setting.SMSTemplate" | translate }}</label>
                <!-- <span class="text-danger"> * </span> -->
                <select [ngClass]="{'form-control': true}"
                  [(ngModel)]="newLoanApplicationStep.codeAcmTemplateSms"
                  >
                  <option *ngFor="let sms of settingSMS" [value]="sms.codeSMSEvent">
                    {{ sms.codeSMSEvent }}
                  </option>
                </select>
              </div>

              <div class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ 'setting.charge_fees' | translate }}</label>

                <p-multiSelect [options]="chargeFees" [(ngModel)]="newLoanApplicationStep.listChargeFees"
                  optionLabel="label"></p-multiSelect>
              </div>

              <div *ngIf="this.activationKey.length !== 0 && testExpiryDate"
              class="position-relative form-group col-4 col-md-4 py-2 ">
              <label>
                {{"setting.setting_steps_workflow.cbs_api"| translate}}:</label>
                <p-multiSelect [options]="cbsApiList" 
                (onChange)="onChangeCbsApi(newLoanApplicationStep,$event)"></p-multiSelect>              
            </div>

              <div *ngIf="this.activationKey.length !== 0 && testExpiryDate"
                class="position-relative form-group col-4 col-md-4 py-2 ">
                <label>
                  {{"setting.journal-entry.type"| translate}}:</label>
                <ngx-select-dropdown tabindex="0" [multiple]="true" [options]="journalEntryTypes"
                  [config]="configJournalEntryType" [(ngModel)]="
        newLoanApplicationStep.journalEntryTypes"></ngx-select-dropdown>
              </div>
              
              <div class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ 'setting.accounting_event' | translate }}</label>
                <input type="text" class="form-control" [(ngModel)]="newLoanApplicationStep.accountingEvent" />
              </div>

              <div class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ 'loan_workflow_setting.charge_disbursement_fee' | translate}}</label>

                <p-multiSelect [options]="disbFeesList" [(ngModel)]="newLoanApplicationStep.disbursmentFeesList"
                  optionLabel="label" ></p-multiSelect>
              </div>

              <div class="position-relative form-group col-4 col-md-4 mt-3"
                *ngIf="newLoanApplicationStep.codeStatutLoan == stepTap[3].tapValue">
                <mat-checkbox [disabled]="readyForDisbCheckedForLoanApp && !newLoanApplicationStep.readyForDisb"
                  [(ngModel)]="newLoanApplicationStep.readyForDisb"
                  (change)="changeReadyForDisbursement($event,newApplicationProcess)"> {{
                  "loan_workflow_setting.ready_for_disbursement" | translate }}</mat-checkbox>
              </div>
              <div class="position-relative form-group col-4 col-md-4 mt-3"
                *ngIf="newLoanApplicationStep.codeStatutLoan == stepTap[3].tapValue">
                <mat-checkbox
                  [disabled]="approvalConditionCheckedForLoanApp && !newLoanApplicationStep.approvalConditions"
                  [(ngModel)]="newLoanApplicationStep.approvalConditions"
                  (change)="changeApprovalConditions($event,newApplicationProcess)">{{
                  'loan_workflow_setting.conditions-approval' | translate }} </mat-checkbox>
              </div>
              <div class="position-relative form-group col-4 col-md-4 mt-3">
                <mat-checkbox [(ngModel)]="newLoanApplicationStep.generationTask">{{
                  'loan_workflow_setting.generation_task' | translate }} </mat-checkbox>
              </div>

              <div class="position-relative form-group col-4 col-md-4 mt-3"
                *ngIf="newLoanApplicationStep.codeStatutLoan == stepTap[2].tapValue || newLoanApplicationStep.codeStatutLoan == stepTap[1].tapValue">
                <mat-checkbox [disabled]="mezaCardCheckedForLoanApp && !newLoanApplicationStep.checkMezaCard"
                  [(ngModel)]="newLoanApplicationStep.checkMezaCard"
                  (change)="changeCheckMezaCard($event,newApplicationProcess)">{{ 'setting.check-meza-card' | translate
                  }}</mat-checkbox>
              </div>

              <div class="position-relative form-group col-4 col-md-4 mt-3">
                <mat-checkbox [(ngModel)]="newLoanApplicationStep.checkFees"
                  (change)="changeCheckFees($event,newApplicationProcess,newLoanApplicationStep)">{{
                  'setting.check-fees' | translate }}</mat-checkbox>
              </div>


              <div class="position-relative form-group col-4 col-md-4 mt-3"
              *ngIf="newLoanApplicationStep.ibScreen == 'sign-contract'">
              <mat-checkbox
                 [disabled]="loanTimerCheckedForLoanApp && !newLoanApplicationStep.activeTimerLoan"
                [(ngModel)]="newLoanApplicationStep.activeTimerLoan"
                (change)="changeActivatedTimer($event,newApplicationProcess)">
                {{ 'loan_workflow_setting.active_loan_timer' | translate }}</mat-checkbox>
            </div>

              <div *ngIf="newLoanApplicationStep.checkFees" class="position-relative form-group col-4 col-md-4 py-2">
                <label>{{ 'setting.fees' | translate }}</label>

                <p-multiSelect [options]="applicationFeesByProduct" [(ngModel)]="newLoanApplicationStep.lstFees"
                  optionLabel="description"></p-multiSelect>
              </div>

              <div class="position-relative form-group col-12 ">
                <app-udf-step-workflow-setting [idWorkflowStep]="newLoanApplicationStep.idWorkFlowStep"
                [workflowStepUdfGroupe]="newLoanApplicationStep.workflowStepUdfGroupe"
                type="1"></app-udf-step-workflow-setting>
              </div>

              <!-- Workflow step conditions -->
              <div class="position-relative form-group col-12 " *ngIf="udfGroups">
                <app-setting-workflow-step-conditions [idWorkflowStep]="newLoanApplicationStep.idWorkFlowStep"
                [settingWorkflowStepConditions]="newLoanApplicationStep.settingWorkFlowStepConditions"
                [udfGroups]="udfGroups"
                type="1">
                </app-setting-workflow-step-conditions>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card-footer">
    <div class="btn-actions-pane-right ACM-header-right-{{translate.currentLang}}" *ngIf="mode != 'TOPUP'">
      <button class="btn btn-primary text-white" (click)="saveProcess('NEW_APPLICATION')">
        {{ "button.save" | translate }}
      </button>
    </div>
    <div class="btn-actions-pane-right ACM-header-right-{{translate.currentLang}}" *ngIf="mode === 'TOPUP'">
      <button class="btn btn-primary text-white" (click)="saveProcess('TOPUP')">
        {{ "button.save" | translate }}
      </button>
    </div>
  </div>
</div>

<ng-template #content let-c="close" let-d="dismiss">
  <div dir="{{getDirection()}}" [ngClass]="{'text-end': translate.currentLang === 'ar'}">
    <form class="position-relative col-xl-12 px-0 col-md-12" (ngSubmit)="onSubmit()" [formGroup]="duplicateGroup">
      <div class="modal-header py-2">
        <h4 class="modal-title">{{ 'setting.duplicate-setting' | translate }}</h4>
        <button type="button" class="close ACM-modal-header-{{translate.currentLang}}" aria-label="Close"
          (click)="d('Cross click')">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body row">
        <div class="position-relative col-xl-12 col-md-12">
          <label>{{'setting.product' | translate}}</label>
          <select class="form-control" id="selectedValue" formControlName="productValues"
            [(ngModel)]="productEntityForDuplicate" required>
            <option [value]="null" default disabled>{{'setting.select_product' | translate}}</option>
            <option *ngFor="let productEntity of productEntitys" [ngValue]="productEntity">
              {{productEntity.description}}
            </option>
          </select>
        </div>
        <div class="position-relative form-group">
          <div>
            <div class="form-group form-check">
              <input class="form-check-input" id="exampleCustomCheckboxReject" type="checkbox" formControlName="confirm"
                (change)="changeChecboxReject()">
              <label class="form-check-label" for="exampleCustomCheckboxReject">{{'button.confirm_checkbox' |   translate}}</label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer py-1">
        <button type="button" class="btn btn-outline-danger" (click)="c('Close click')">{{'button.close' |
          translate}}</button>
        <button type="submit" class="btn btn-success text-white">{{ 'button.validate' | translate
          }}</button>
      </div>
    </form>
  </div>
</ng-template>
